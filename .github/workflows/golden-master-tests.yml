# Workflow GitHub Actions pour les Tests Golden Master
# VÃ©rifie que le programme Python reproduit le comportement COBOL

name: Tests Golden Master

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'python_accountsystem/**'
      - 'tests/**'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'python_accountsystem/**'
      - 'tests/**'
      - 'requirements.txt'

jobs:
  golden-master-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” VÃ©rification de la structure des tests
      run: |
        echo "ğŸ“‹ VÃ©rification des fichiers de test..."
        ls -la tests/inputs/
        ls -la tests/approved/
        echo "âœ… Structure des tests validÃ©e"
    
    - name: ğŸ”„ GÃ©nÃ©ration des fichiers received
      run: |
        echo "ğŸ”„ GÃ©nÃ©ration des sorties Python..."
        python tests/generate_received_files.py
        echo "âœ… Fichiers received gÃ©nÃ©rÃ©s"
    
    - name: ğŸ§ª ExÃ©cution des Tests Golden Master
      id: golden_master_tests
      run: |
        echo "ğŸ§ª Lancement des tests Golden Master..."
        python tests/test_golden_master.py
      continue-on-error: true
    
    - name: ğŸ“Š Tests ApprovalTests (optionnel)
      if: always()
      run: |
        echo "ğŸ“Š Tests avec ApprovalTests..."
        python -m pytest tests/test_approval.py::TestBulkComparison::test_all_cases_match_approved -v
      continue-on-error: true
    
    - name: ğŸ¨ GÃ©nÃ©ration des diffs visuels
      if: always()
      run: |
        echo "ğŸ¨ GÃ©nÃ©ration des diffs visuels en cas d'Ã©chec..."
        python tests/test_visual_diff.py
      continue-on-error: true
    
    - name: ğŸ¯ Rapport final
      if: always()
      run: |
        echo "ğŸ“ˆ RAPPORT DES TESTS GOLDEN MASTER"
        echo "=================================="
        
        # Statistiques des fichiers
        echo "ğŸ“‹ Statistiques:"
        echo "- Fichiers approved: $(ls tests/approved/*.approved.txt | wc -l)"
        echo "- Fichiers received: $(ls tests/received/*.received.txt | wc -l)"
        echo "- Cas de test: $(ls tests/inputs/*.in | wc -l)"
        
        # VÃ©rifier le statut des tests Golden Master
        if [ "${{ steps.golden_master_tests.outcome }}" = "failure" ]; then
          echo "âŒ Tests Golden Master: Ã‰CHEC DÃ‰TECTÃ‰"
          echo "ğŸ“Š VÃ©rification de compatibilitÃ© COBOLâ†’Python: RÃ‰GRESSION"
          echo "ğŸš¨ Des diffÃ©rences ont Ã©tÃ© dÃ©tectÃ©es entre COBOL et Python"
        else
          echo "âœ… Tests Golden Master: RÃ‰USSIS"
          echo "ğŸ“Š VÃ©rification de compatibilitÃ© COBOLâ†’Python: OK"
        fi
    
    - name: ğŸ’¾ Archivage des diffs visuels
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-diffs-${{ github.run_number }}
        path: |
          tests/visual_diffs/
          tests/received/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: ğŸš¨ Ã‰chec si tests Golden Master Ã©chouent
      if: steps.golden_master_tests.outcome == 'failure'
      run: |
        echo "ğŸš¨ Ã‰CHEC DU WORKFLOW - RÃ‰GRESSIONS DÃ‰TECTÃ‰ES"
        echo "Les tests Golden Master ont Ã©chouÃ©."
        echo "VÃ©rifiez les diffÃ©rences entre les sorties COBOL et Python."
        echo ""
        echo "ğŸ¨ Diffs visuels disponibles dans les artifacts du workflow"
        echo "ğŸ‘‰ TÃ©lÃ©chargez 'visual-diffs-${{ github.run_number }}' pour voir les dÃ©tails"
        exit 1
