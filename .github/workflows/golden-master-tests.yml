# Workflow GitHub Actions pour les Tests Golden Master
# Vérifie que le programme Python reproduit le comportement COBOL

name: Tests Golden Master

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'python_accountsystem/**'
      - 'tests/**'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
    paths:
      - 'python_accountsystem/**'
      - 'tests/**'
      - 'requirements.txt'

jobs:
  golden-master-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout du code
      uses: actions/checkout@v4
    
    - name: 🐍 Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 📦 Installation des dépendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 🔍 Vérification de la structure des tests
      run: |
        echo "📋 Vérification des fichiers de test..."
        ls -la tests/inputs/
        ls -la tests/approved/
        echo "✅ Structure des tests validée"
    
    - name: 🔄 Génération des fichiers received
      run: |
        echo "🔄 Génération des sorties Python..."
        python tests/generate_received_files.py
        echo "✅ Fichiers received générés"
    
    - name: 🧪 Exécution des Tests Golden Master
      id: golden_master_tests
      run: |
        echo "🧪 Lancement des tests Golden Master..."
        python tests/test_golden_master.py
      continue-on-error: true
    
    - name: 📊 Tests ApprovalTests (optionnel)
      if: always()
      run: |
        echo "📊 Tests avec ApprovalTests..."
        python -m pytest tests/test_approval.py::TestBulkComparison::test_all_cases_match_approved -v
      continue-on-error: true
    
    - name: 🎨 Génération des diffs visuels
      if: always()
      run: |
        echo "🎨 Génération des diffs visuels en cas d'échec..."
        python tests/test_visual_diff.py
      continue-on-error: true
    
    - name: 🎯 Rapport final
      if: always()
      run: |
        echo "📈 RAPPORT DES TESTS GOLDEN MASTER"
        echo "=================================="
        
        # Statistiques des fichiers
        echo "📋 Statistiques:"
        echo "- Fichiers approved: $(ls tests/approved/*.approved.txt | wc -l)"
        echo "- Fichiers received: $(ls tests/received/*.received.txt | wc -l)"
        echo "- Cas de test: $(ls tests/inputs/*.in | wc -l)"
        
        # Vérifier le statut des tests Golden Master
        if [ "${{ steps.golden_master_tests.outcome }}" = "failure" ]; then
          echo "❌ Tests Golden Master: ÉCHEC DÉTECTÉ"
          echo "📊 Vérification de compatibilité COBOL→Python: RÉGRESSION"
          echo "🚨 Des différences ont été détectées entre COBOL et Python"
        else
          echo "✅ Tests Golden Master: RÉUSSIS"
          echo "📊 Vérification de compatibilité COBOL→Python: OK"
        fi
    
    - name: 💾 Archivage des diffs visuels
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-diffs-${{ github.run_number }}
        path: |
          tests/visual_diffs/
          tests/received/
        retention-days: 30
        if-no-files-found: ignore
    
    - name: 🚨 Échec si tests Golden Master échouent
      if: steps.golden_master_tests.outcome == 'failure'
      run: |
        echo "🚨 ÉCHEC DU WORKFLOW - RÉGRESSIONS DÉTECTÉES"
        echo "Les tests Golden Master ont échoué."
        echo "Vérifiez les différences entre les sorties COBOL et Python."
        echo ""
        echo "🎨 Diffs visuels disponibles dans les artifacts du workflow"
        echo "👉 Téléchargez 'visual-diffs-${{ github.run_number }}' pour voir les détails"
        exit 1
